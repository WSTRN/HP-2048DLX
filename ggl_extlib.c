#include "ggl_extlib.h"
#include <stdint.h>
#include <string.h>

unsigned int logic_operator(unsigned int dest, unsigned int source, int param)
{
	switch(param)
	{
	case LG_AND:
		return dest & source;
	case LG_OR:
		return dest | source;
	case LG_XOR:
		return dest ^ source;
	case LG_NOT:
		return ~source;
	default:
		return source;
	}

}
void ggle_bmp(gglsurface *dest, int x, int y, const uint8_t* bmp, int w, int h)
{
	gglsurface tmp;
	tmp.addr = (int*)bmp;
	tmp.width = w;
	tmp.x = 0;
	tmp.y = 0;
	dest->x = x;
	dest->y = y;
	ggl_bitblt(dest, &tmp, w, h);
	dest->x = 0;
	dest->y = 0;
}
void ggle_bmp_logic(gglsurface *dest, int x, int y, const uint8_t* bmp, int w, int h, int logic)
{
	gglsurface tmp;
	tmp.addr = (int*)bmp;
	tmp.width = w;
	tmp.x = 0;
	tmp.y = 0;
	dest->x = x;
	dest->y = y;
	ggl_bitbltoper(dest, &tmp, w, h, logic, logic_operator);
	dest->x = 0;
	dest->y = 0;
}

const unsigned int Txt_Fonts[TXT_FONTS][140]={
    {
    4141870527, 3682580223, 1845419005, 3086708726, 3756900315, 2142699373, 4275830199, 4218418911, 
    3988773759, 3070193150, 3690838011, 1878450157, 3218833334, 4285398747, 4256693103, 37386, 
    3490052053, 4092635221, 1436811305, 588403370,  6094850,    2154823681, 44070620,   2992575806, 
    686520638,  1671231474, 2767708143, 941654081,  1117922190, 573207170,  3334254519, 1567855165, 
    1843292668, 3526962103, 3687996563, 1438308644, 4158356918, 2875905864, 2913688939, 2297336406, 
    3689788763, 2109037418, 1268071241, 823204133,  2499805191, 2281737134, 1299214898, 1567291594, 
    3912944275, 1518754947, 1421565074, 3808118454, 2238323432, 493120424,  2045104738, 3687167243, 
    1863658027, 678935377,  882006293,  2155380735 },
    {
    4234352839, 4287390488, 4294020195, 536752524,  1677706801, 2357196998, 831520536,  3325165539, 
    415645692,  1662568447, 2355304703, 4052509471, 4264660067, 4291178892, 2147010097, 2415859910, 
    838853400,  3326082147, 415760268,  1662582769, 2355306494, 831284223,  3325135999, 4173738383, 
    4279813681, 4293073094, 1073505048, 3355413603, 419426700,  1663041073, 2355363782, 831291384, 
    3325136895, 415642111,  3810051647, 0,          69273664,   290082816,  2711383,    3567402638, 
    797543560,  2291718442, 582118152,  2147483665, 277090376,  545530400,  78355794,   8714504, 
    97,         268436448,  0,          207618594,  570455143,  1556464741, 138575313,  143167484, 
    1141924577, 424867973,  4168622475, 2357754417, 2009211408, 2222220008, 3318647902, 288361568, 
    415236492,  50888840,   2283831808, 2082406432, 2181597315, 2719027204, 1950538453, 3465314072, 
    3352399779, 523907204,  586041905,  2360997955, 3498573576, 2047902627, 163983244,  1677248063, 
    554189436,  3792733478, 1179960613, 406982788,  1058920113, 2355305686, 1904976664, 3324965987, 
    3896643212, 1666791377, 2410227898, 812671727,  2424578313, 415641995,  2736309802, 610491094, 
    2861323333, 1177652308, 1108599057, 286243080,  1108402241, 68174049,   138548104,  2826960896, 
    31,         1627652096, 230136,     3188766307, 520097412,  585139635,  2354970682, 1065584199, 
    277094400,  4173082244, 764986912,  538460728,  1076921638, 1108518441, 638616609,  469789365, 
    2906655590, 830996712,  3324903485, 524419075,  3807413248, 3059812352, 260277220,  1896366668, 
    4600219,    1074316618, 536942806,  2852139618, 845153362,  1650458872, 2291107972, 1091052048, 
    2216757378, 272900608,  81149959,   4294967295 },
    {
    4234354686, 831520536,  3355413603, 4291179007, 3810066417, 2357196998, 1073505055, 4264660991, 
    415760268,  1677706801, 4293073151, 4052516856, 3326082147, 536752527,  4279814143, 2355363782, 
    838853400,  4294020223, 4173742076, 1663041073, 2415859911, 4287390719, 3325165539, 419426700, 
    2147010111, 16,         2214663328, 719550,     2815542774, 1682231281, 2357117472, 2232450, 
    272765204,  1334920231, 3359637892, 1073868800, 202769,     286291051,  387023911,  4229383166, 
    193194183,  3775914464, 4191220829, 4035478644, 1561803311, 194560049,  2349009025, 285478974, 
    260113425,  283678724,  1885034298, 1066171679, 1204782112, 4282790391, 3788013552, 3827361870, 
    780959512,  4236519422, 692687247,  2736275984, 4235679942, 967631592,  3324966013, 138031515, 
    4246685231, 2206461840, 2216977176, 3123808905, 416721546,  2292761924, 557720099,  3997307112, 
    545393540,  557353608,  31,         822345784,  797679887,  1203797024, 4035309947, 2749905361, 
    3290491068, 1048949528, 2684895644, 554274948,  3106152712, 808803028,  479503367,  1177421731, 
    3892441464, 1097646606, 2198194298, 275785001,  806524176,  147237382,  2290811210, 570548771, 
    3324119138, 277095176,  573573548,  2181038079 }
};
void ggle_Pixel(gglsurface *dest, int x, int y, int v)
{
    int off=(y*dest->width+x);
    register int *word_addr=(int *)dest->addr+ (off>>3);

    if(v)      *(word_addr) |=  (0x0000000f<<(4*(off%8)));
    else          *(word_addr) &= ~(0x0000000f<<(4*(off%8)));
}
void ggle_Char(gglsurface *dest, char c, int x, int y, int f, int w, int h)
{
  unsigned int *font = Txt_Fonts[f];
  unsigned char a,b,v;
  int offbyte = (c*w*h)>>5;
  int offbit  = (c*w*h)&31;
  if(!font) return;

  for(b=0;b<h;b++)
  {
    for(a=0;a<w;a++)
    {
      v = (font[offbyte]&(1<<(31-offbit)))!=0;
      ggle_Pixel(dest,x+a,y+b,v?0:1);
      if(offbit++==31) offbyte++, offbit=0;
    }
  }
}

void ggle_Text(gglsurface *dest, const char *s, int x, int y, int f)
{
  const unsigned char Txt_Widths[TXT_FONTS]  = { 3, 5, 5 };
  const unsigned char Txt_Heights[TXT_FONTS] = { 5, 7, 5 };
  const unsigned char w = Txt_Widths[f];
  const unsigned char h = Txt_Heights[f];
  char *p = (char *)s;
  int i;

  while(*p)
  {
    ggle_Char(dest, *p,x,y,f,w,h);
    p++;
    x += w;
    // if(*p) for(i=0;i<h;i++) ggle_Pixel(dest, x,y+i,1);
    x++;
  }
}